steps:
  - label: "ğŸ”„ Prepare Build VMs"
    key: "prepare-vms"
    command: |
      echo "--- ğŸ—‘ Cleanup old VMs"
      tart list --running | xargs -I{} tart stop {}
      
      echo "--- ğŸ“¦ Restore/Create Base Images"
      ./infrastructure/setup/create-base-vms.sh
      
      echo "--- ğŸ’¾ Cache Status"
      CACHE_DIR="/opt/buildkite-agent/cache"
      echo "Dependencies cache size: $(du -sh $CACHE_DIR/deps/* 2>/dev/null || echo 'Empty')"
      echo "Build cache size: $(du -sh $CACHE_DIR/builds/* 2>/dev/null || echo 'Empty')"
      
      echo "--- ğŸ“Š Resource Check"
      echo "Disk space:"
      df -h /opt/tart/images /opt/buildkite-agent/cache
      echo "Memory status:"
      vm_stat
      echo "CPU load:"
      sysctl -n hw.ncpu kern.cpuload
    agents:
      queue: "on-prem"
      arch: "arm64"

  - label: "ğŸ— Build Dependencies"
    key: "build-deps"
    depends_on: "prepare-vms"
    command: |
      echo "--- ğŸ“¥ Smart Cache Check"
      CACHE_DIR="/opt/buildkite-agent/cache"
      DEPS_HASH=$(cat package.json yarn.lock | sha256sum | cut -d' ' -f1)
      CACHE_PATH="$CACHE_DIR/deps-$DEPS_HASH"
      
      if [ -d "$CACHE_PATH" ] && [ -f "$CACHE_PATH/cache.meta" ]; then
        echo "Using cached dependencies..."
        cp -r "$CACHE_PATH"/* .
        echo "Cache hit from $(cat "$CACHE_PATH/cache.meta")"
      else
        echo "Building dependencies fresh..."
        bun install
        
        # Cache with metadata
        mkdir -p "$CACHE_PATH"
        cp -r node_modules "$CACHE_PATH/"
        date > "$CACHE_PATH/cache.meta"
        echo "Dependencies cached at $(date)"
      fi
      
      # Rotate old caches (keep last 5)
      ls -t $CACHE_DIR/deps-* | tail -n +6 | xargs rm -rf
    agents:
      queue: "on-prem"
      arch: "arm64"

  # Matrix build for different architectures
  - group: "ğŸ›  Build Matrix"
    key: "build-matrix"
    depends_on: "build-deps"
    steps:
      - label: "ğŸ›  Build Bun (M1)"
        key: "build-bun-m1"
        command: .buildkite/scripts/build.sh
        env:
          ARCH: "arm64"
          CHIP: "m1"
          VM_BASE: "base-m1"
        agents:
          queue: "on-prem"
          arch: "arm64"
          chip: "m1"

      - label: "ğŸ›  Build Bun (M2)"
        key: "build-bun-m2"
        command: .buildkite/scripts/build.sh
        env:
          ARCH: "arm64"
          CHIP: "m2"
          VM_BASE: "base-m2"
        agents:
          queue: "on-prem"
          arch: "arm64"
          chip: "m2"

      - label: "ğŸ›  Build Bun (M3)"
        key: "build-bun-m3"
        command: .buildkite/scripts/build.sh
        env:
          ARCH: "arm64"
          CHIP: "m3"
          VM_BASE: "base-m3"
        agents:
          queue: "on-prem"
          arch: "arm64"
          chip: "m3"

      - label: "ğŸ›  Build Bun (Intel)"
        key: "build-bun-intel"
        command: .buildkite/scripts/build.sh
        env:
          ARCH: "x64"
          CHIP: "intel"
          VM_BASE: "base-intel"
        agents:
          queue: "on-prem"
          arch: "x64"
          chip: "intel"

  # Matrix test for different architectures
  - group: "ğŸ§ª Test Matrix"
    key: "test-matrix"
    depends_on: "build-matrix"
    steps:
      - label: "ğŸ§ª Test Bun (M1)"
        key: "test-bun-m1"
        command: .buildkite/scripts/test.sh
        env:
          ARCH: "arm64"
          CHIP: "m1"
          VM_BASE: "base-m1"
        agents:
          queue: "on-prem"
          arch: "arm64"
          chip: "m1"

      - label: "ğŸ§ª Test Bun (M2)"
        key: "test-bun-m2"
        command: .buildkite/scripts/test.sh
        env:
          ARCH: "arm64"
          CHIP: "m2"
          VM_BASE: "base-m2"
        agents:
          queue: "on-prem"
          arch: "arm64"
          chip: "m2"

      - label: "ğŸ§ª Test Bun (M3)"
        key: "test-bun-m3"
        command: .buildkite/scripts/test.sh
        env:
          ARCH: "arm64"
          CHIP: "m3"
          VM_BASE: "base-m3"
        agents:
          queue: "on-prem"
          arch: "arm64"
          chip: "m3"

      - label: "ğŸ§ª Test Bun (Intel)"
        key: "test-bun-intel"
        command: .buildkite/scripts/test.sh
        env:
          ARCH: "x64"
          CHIP: "intel"
          VM_BASE: "base-intel"
        agents:
          queue: "on-prem"
          arch: "x64"
          chip: "intel"

  - wait

  - label: "ğŸ“¦ Package Artifacts"
    key: "package"
    depends_on: "test-matrix"
    command: |
      echo "--- ğŸ“¥ Downloading Artifacts"
      for arch in m1 m2 m3 intel; do
        buildkite-agent artifact download "bun-darwin-$arch-*.tar.gz" .
      done
      
      echo "--- ğŸ” Verifying Artifacts"
      for pkg in bun-darwin-*.tar.gz; do
        echo "Checking $pkg..."
        tar tzf $pkg | grep "bun$" || exit 1
      done
      
      echo "--- ğŸ’¾ Caching Artifacts"
      CACHE_DIR="/opt/buildkite-agent/cache/builds"
      BUILD_DATE=$(date +%Y%m%d)
      mkdir -p "$CACHE_DIR/$BUILD_DATE"
      cp bun-darwin-*.tar.gz "$CACHE_DIR/$BUILD_DATE/"
      
      # Keep only last 7 days of builds
      find "$CACHE_DIR" -type d -mtime +7 -exec rm -rf {} +
      
      echo "--- ğŸ“Š Cache Statistics"
      echo "Current cache size:"
      du -sh "$CACHE_DIR"
      echo "Cache history:"
      ls -lh "$CACHE_DIR"
    agents:
      queue: "on-prem"
      arch: "arm64" 