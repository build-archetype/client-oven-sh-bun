priority: 0
steps:
- 
    label: Build Base Image
    key: "build-base-image"
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    command:
    - mkdir -p $HOME/.docker
    - cat > $HOME/.docker/config.json << EOF
    - |
      {
        "auths": {
          "ghcr.io": {
            "auth": "$(echo -n "$GITHUB_USERNAME:$GITHUB_TOKEN" | base64)"
          }
        }
      }
    - EOF
    - chmod 600 $HOME/.docker/config.json
    - echo "$GITHUB_TOKEN" > /tmp/github-token.txt
    - echo "$GITHUB_USERNAME" > /tmp/github-username.txt
    - chmod +x .buildkite/scripts/ensure-bun-image.sh
    - set -x
    - .buildkite/scripts/ensure-bun-image.sh 2>&1 | tee -a base-image-build.log
    - rm -f /tmp/github-token.txt /tmp/github-username.txt
    retry:
      automatic:
      - 
              exit_status: 1
              limit: 2
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
    artifact_paths:
    - base-image-build.log
    soft_fail: false
    timeout_in_minutes: 90
  
- 
    key: "darwin-aarch64-build-vendor"
    label: ":darwin: aarch64 - build-vendor"
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764866-9f2c9a0f-31ce-41c3-8ddc-b9fd8206b080
    - tart run bun-build-1748826764866-9f2c9a0f-31ce-41c3-8ddc-b9fd8206b080 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764866-9f2c9a0f-31ce-41c3-8ddc-b9fd8206b080 "cd '/Volumes/My Shared Files/workspace' && ls -la && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764866-9f2c9a0f-31ce-41c3-8ddc-b9fd8206b080
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-cpp"
    label: ":darwin: aarch64 - build-cpp"
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_CPP_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764870-744ba301-95bb-492c-ad3c-620a9132eb86
    - tart run bun-build-1748826764870-744ba301-95bb-492c-ad3c-620a9132eb86 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764870-744ba301-95bb-492c-ad3c-620a9132eb86 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764870-744ba301-95bb-492c-ad3c-620a9132eb86 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764870-744ba301-95bb-492c-ad3c-620a9132eb86
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-zig"
    label: ":darwin: aarch64 - build-zig"
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    timeout_in_minutes: 35
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764875-e395b670-9cfb-4283-ab85-937ad3cd70d8
    - tart run bun-build-1748826764875-e395b670-9cfb-4283-ab85-937ad3cd70d8 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764875-e395b670-9cfb-4283-ab85-937ad3cd70d8 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun-zig --toolchain darwin-aarch64"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764875-e395b670-9cfb-4283-ab85-937ad3cd70d8
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-bun"
    label: ":darwin: aarch64 - build-bun"
    depends_on:
    - darwin-aarch64-build-cpp
    - darwin-aarch64-build-zig
    - build-base-image
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_LINK_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764879-125d59bd-758a-4c4a-8881-86a2ee21a469
    - tart run bun-build-1748826764879-125d59bd-758a-4c4a-8881-86a2ee21a469 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764879-125d59bd-758a-4c4a-8881-86a2ee21a469 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764879-125d59bd-758a-4c4a-8881-86a2ee21a469
  
- 
    key: "darwin-x64-build-vendor"
    label: ":darwin: x64 - build-vendor"
    agents:
      queue: darwin
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764884-28c45b80-d390-4ed8-a191-a2b036315368
    - tart run bun-build-1748826764884-28c45b80-d390-4ed8-a191-a2b036315368 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764884-28c45b80-d390-4ed8-a191-a2b036315368 "cd '/Volumes/My Shared Files/workspace' && ls -la && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764884-28c45b80-d390-4ed8-a191-a2b036315368
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-cpp"
    label: ":darwin: x64 - build-cpp"
    agents:
      queue: darwin
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_CPP_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764888-3d096598-8ff4-4635-b156-165fd1684273
    - tart run bun-build-1748826764888-3d096598-8ff4-4635-b156-165fd1684273 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764888-3d096598-8ff4-4635-b156-165fd1684273 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764888-3d096598-8ff4-4635-b156-165fd1684273 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764888-3d096598-8ff4-4635-b156-165fd1684273
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-zig"
    label: ":darwin: x64 - build-zig"
    agents:
      queue: darwin
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    timeout_in_minutes: 35
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764891-53c500a7-2f0d-4bde-bd1a-a29188db7ca3
    - tart run bun-build-1748826764891-53c500a7-2f0d-4bde-bd1a-a29188db7ca3 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764891-53c500a7-2f0d-4bde-bd1a-a29188db7ca3 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun-zig --toolchain darwin-x64"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764891-53c500a7-2f0d-4bde-bd1a-a29188db7ca3
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-bun"
    label: ":darwin: x64 - build-bun"
    depends_on:
    - darwin-x64-build-cpp
    - darwin-x64-build-zig
    - build-base-image
    agents:
      queue: darwin
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_LINK_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764895-7ccbf010-b745-4b84-9342-1be9be2501ff
    - tart run bun-build-1748826764895-7ccbf010-b745-4b84-9342-1be9be2501ff --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764895-7ccbf010-b745-4b84-9342-1be9be2501ff "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764895-7ccbf010-b745-4b84-9342-1be9be2501ff
  
- 
    key: "darwin-aarch64-14-test-bun"
    label: ":darwin: 14 aarch64 - test-bun"
    depends_on:
    - darwin-aarch64-build-bun
    - build-base-image
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764899-2e527eca-8a71-4dc5-a7ce-c646cd0a46db
    - tart run bun-build-1748826764899-2e527eca-8a71-4dc5-a7ce-c646cd0a46db --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764899-2e527eca-8a71-4dc5-a7ce-c646cd0a46db "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-aarch64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764899-2e527eca-8a71-4dc5-a7ce-c646cd0a46db
  
- 
    key: "darwin-aarch64-13-test-bun"
    label: ":darwin: 13 aarch64 - test-bun"
    depends_on:
    - darwin-aarch64-build-bun
    - build-base-image
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764903-a3d5d45e-137c-4d9a-ab90-48fe370837e6
    - tart run bun-build-1748826764903-a3d5d45e-137c-4d9a-ab90-48fe370837e6 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764903-a3d5d45e-137c-4d9a-ab90-48fe370837e6 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-aarch64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764903-a3d5d45e-137c-4d9a-ab90-48fe370837e6
  
- 
    key: "darwin-x64-14-test-bun"
    label: ":darwin: 14 x64 - test-bun"
    depends_on:
    - darwin-x64-build-bun
    - build-base-image
    agents:
      queue: darwin
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764907-a5d3cc10-a12c-4d6b-b273-83a7478a4cd0
    - tart run bun-build-1748826764907-a5d3cc10-a12c-4d6b-b273-83a7478a4cd0 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764907-a5d3cc10-a12c-4d6b-b273-83a7478a4cd0 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-x64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764907-a5d3cc10-a12c-4d6b-b273-83a7478a4cd0
  
- 
    key: "darwin-x64-13-test-bun"
    label: ":darwin: 13 x64 - test-bun"
    depends_on:
    - darwin-x64-build-bun
    - build-base-image
    agents:
      queue: darwin
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826764910-2c747ef7-863b-43c9-a78b-e9387a720506
    - tart run bun-build-1748826764910-2c747ef7-863b-43c9-a78b-e9387a720506 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826764910-2c747ef7-863b-43c9-a78b-e9387a720506 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-x64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826764910-2c747ef7-863b-43c9-a78b-e9387a720506
  
- 
    key: release
    label: ":rocket:"
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    depends_on:
    - darwin-aarch64-build-bun
    - darwin-x64-build-bun
    env:
      CANARY: 1
    command: ".buildkite/scripts/upload-release.sh"
  
- 
    key: benchmark
    label: ðŸ“Š
    agents:
      queue: darwin
      os: darwin
      arch: arm64
      tart: true
    depends_on: "darwin-aarch64-build-bun"
    command: "node .buildkite/scripts/upload-benchmark.mjs"
  
