priority: 0
steps:
- 
    label: Build Base Image
    key: "build-base-image"
    agents:
      os: darwin
      arch: arm64
      tart: true
    command:
    - mkdir -p $HOME/.docker
    - cat > $HOME/.docker/config.json << EOF
    - |
      {
        "auths": {
          "ghcr.io": {
            "auth": "$(echo -n "$GITHUB_USERNAME:$GITHUB_TOKEN" | base64)"
          }
        }
      }
    - EOF
    - chmod 600 $HOME/.docker/config.json
    - echo "$GITHUB_TOKEN" > /tmp/github-token.txt
    - echo "$GITHUB_USERNAME" > /tmp/github-username.txt
    - chmod +x .buildkite/scripts/ensure-bun-image.sh
    - set -x
    - .buildkite/scripts/ensure-bun-image.sh 2>&1 | tee -a base-image-build.log
    - rm -f /tmp/github-token.txt /tmp/github-username.txt
    retry:
      automatic:
      - 
              exit_status: 1
              limit: 2
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
    artifact_paths:
    - base-image-build.log
    soft_fail: false
    timeout_in_minutes: 90
  
- 
    key: "darwin-aarch64-build-vendor"
    label: ":darwin: aarch64 - build-vendor"
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266374-8ab71377-3f72-462f-9af7-65f544b86619
    - tart run bun-build-1748825266374-8ab71377-3f72-462f-9af7-65f544b86619 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266374-8ab71377-3f72-462f-9af7-65f544b86619 "cd '/Volumes/My Shared Files/workspace' && ls -la && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266374-8ab71377-3f72-462f-9af7-65f544b86619
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-cpp"
    label: ":darwin: aarch64 - build-cpp"
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_CPP_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266382-11109552-e48b-4db9-ae56-f995130fa117
    - tart run bun-build-1748825266382-11109552-e48b-4db9-ae56-f995130fa117 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266382-11109552-e48b-4db9-ae56-f995130fa117 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266382-11109552-e48b-4db9-ae56-f995130fa117 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266382-11109552-e48b-4db9-ae56-f995130fa117
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-zig"
    label: ":darwin: aarch64 - build-zig"
    agents:
      os: linux
      arch: x64
      abi: musl
      distro: alpine
      release: 3.21
      robobun: true
      robobun2: true
      image-name: "linux-x64-321-alpine-musl-v10"
      instance-type: c7i.2xlarge
      cpu-count: 4
      threads-per-core: 1
      preemptible: false
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    timeout_in_minutes: 35
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266388-8bd504ff-e93e-41e9-ac06-37e6acf48d33
    - tart run bun-build-1748825266388-8bd504ff-e93e-41e9-ac06-37e6acf48d33 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266388-8bd504ff-e93e-41e9-ac06-37e6acf48d33 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun-zig --toolchain darwin-aarch64"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266388-8bd504ff-e93e-41e9-ac06-37e6acf48d33
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-bun"
    label: ":darwin: aarch64 - build-bun"
    depends_on:
    - darwin-aarch64-build-cpp
    - darwin-aarch64-build-zig
    - build-base-image
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_LINK_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266393-e7a00a40-4962-4125-a75c-297ffff86fc1
    - tart run bun-build-1748825266393-e7a00a40-4962-4125-a75c-297ffff86fc1 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266393-e7a00a40-4962-4125-a75c-297ffff86fc1 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266393-e7a00a40-4962-4125-a75c-297ffff86fc1
  
- 
    key: "darwin-x64-build-vendor"
    label: ":darwin: x64 - build-vendor"
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266397-8e497bae-50b7-43c6-8a4c-4d295feaa4fb
    - tart run bun-build-1748825266397-8e497bae-50b7-43c6-8a4c-4d295feaa4fb --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266397-8e497bae-50b7-43c6-8a4c-4d295feaa4fb "cd '/Volumes/My Shared Files/workspace' && ls -la && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266397-8e497bae-50b7-43c6-8a4c-4d295feaa4fb
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-cpp"
    label: ":darwin: x64 - build-cpp"
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_CPP_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266401-1354b76f-2198-45b5-842b-ec726d2475e2
    - tart run bun-build-1748825266401-1354b76f-2198-45b5-842b-ec726d2475e2 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266401-1354b76f-2198-45b5-842b-ec726d2475e2 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266401-1354b76f-2198-45b5-842b-ec726d2475e2 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266401-1354b76f-2198-45b5-842b-ec726d2475e2
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-zig"
    label: ":darwin: x64 - build-zig"
    agents:
      os: linux
      arch: x64
      abi: musl
      distro: alpine
      release: 3.21
      robobun: true
      robobun2: true
      image-name: "linux-x64-321-alpine-musl-v10"
      instance-type: c7i.2xlarge
      cpu-count: 4
      threads-per-core: 1
      preemptible: false
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    timeout_in_minutes: 35
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266405-9ad7fb20-0913-48fd-bbf7-71ca37508a9f
    - tart run bun-build-1748825266405-9ad7fb20-0913-48fd-bbf7-71ca37508a9f --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266405-9ad7fb20-0913-48fd-bbf7-71ca37508a9f "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun-zig --toolchain darwin-x64"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266405-9ad7fb20-0913-48fd-bbf7-71ca37508a9f
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-bun"
    label: ":darwin: x64 - build-bun"
    depends_on:
    - darwin-x64-build-cpp
    - darwin-x64-build-zig
    - build-base-image
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_LINK_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266408-2e31be58-3cf3-454e-9233-1a8b513435df
    - tart run bun-build-1748825266408-2e31be58-3cf3-454e-9233-1a8b513435df --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266408-2e31be58-3cf3-454e-9233-1a8b513435df "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266408-2e31be58-3cf3-454e-9233-1a8b513435df
  
- 
    key: "darwin-aarch64-14-test-bun"
    label: ":darwin: 14 aarch64 - test-bun"
    depends_on:
    - darwin-aarch64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266413-c4f663ba-4c83-42d6-b385-d1f075ccb6ff
    - tart run bun-build-1748825266413-c4f663ba-4c83-42d6-b385-d1f075ccb6ff --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266413-c4f663ba-4c83-42d6-b385-d1f075ccb6ff "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-aarch64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266413-c4f663ba-4c83-42d6-b385-d1f075ccb6ff
  
- 
    key: "darwin-aarch64-13-test-bun"
    label: ":darwin: 13 aarch64 - test-bun"
    depends_on:
    - darwin-aarch64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266417-8ca80658-1a83-4170-8708-b43eed0f9cf5
    - tart run bun-build-1748825266417-8ca80658-1a83-4170-8708-b43eed0f9cf5 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266417-8ca80658-1a83-4170-8708-b43eed0f9cf5 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-aarch64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266417-8ca80658-1a83-4170-8708-b43eed0f9cf5
  
- 
    key: "darwin-x64-14-test-bun"
    label: ":darwin: 14 x64 - test-bun"
    depends_on:
    - darwin-x64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266421-07f6df99-7ab6-4589-b3aa-47998104e7ce
    - tart run bun-build-1748825266421-07f6df99-7ab6-4589-b3aa-47998104e7ce --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266421-07f6df99-7ab6-4589-b3aa-47998104e7ce "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-x64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266421-07f6df99-7ab6-4589-b3aa-47998104e7ce
  
- 
    key: "darwin-x64-13-test-bun"
    label: ":darwin: 13 x64 - test-bun"
    depends_on:
    - darwin-x64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748825266425-d1ace370-234d-4f66-8a11-a5e07383cca6
    - tart run bun-build-1748825266425-d1ace370-234d-4f66-8a11-a5e07383cca6 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748825266425-d1ace370-234d-4f66-8a11-a5e07383cca6 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-x64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748825266425-d1ace370-234d-4f66-8a11-a5e07383cca6
  
- 
    key: release
    label: ":rocket:"
    agents:
      os: darwin
      arch: arm64
      tart: true
    depends_on:
    - darwin-aarch64-build-bun
    - darwin-x64-build-bun
    env:
      CANARY: 1
    command: ".buildkite/scripts/upload-release.sh"
  
- 
    key: benchmark
    label: ðŸ“Š
    agents:
      os: darwin
      arch: arm64
      tart: true
    depends_on: "linux-x64-build-bun"
    command: "node .buildkite/scripts/upload-benchmark.mjs"
  
