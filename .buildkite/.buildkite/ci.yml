priority: 0
steps:
- 
    label: Build Base Image
    key: "build-base-image"
    agents:
      os: darwin
      arch: arm64
      tart: true
    command:
    - mkdir -p $HOME/.docker
    - cat > $HOME/.docker/config.json << EOF
    - |
      {
        "auths": {
          "ghcr.io": {
            "auth": "$(echo -n "$GITHUB_USERNAME:$GITHUB_TOKEN" | base64)"
          }
        }
      }
    - EOF
    - chmod 600 $HOME/.docker/config.json
    - echo "$GITHUB_TOKEN" > /tmp/github-token.txt
    - echo "$GITHUB_USERNAME" > /tmp/github-username.txt
    - chmod +x .buildkite/scripts/ensure-bun-image.sh
    - set -x
    - .buildkite/scripts/ensure-bun-image.sh 2>&1 | tee -a base-image-build.log
    - rm -f /tmp/github-token.txt /tmp/github-username.txt
    retry:
      automatic:
      - 
              exit_status: 1
              limit: 2
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
    artifact_paths:
    - base-image-build.log
    soft_fail: false
    timeout_in_minutes: 90
  
- 
    key: "darwin-aarch64-build-vendor"
    label: ":darwin: aarch64 - build-vendor"
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445871-522bf1ce-98e9-4547-b83f-a216139c59c2
    - tart run bun-build-1748826445871-522bf1ce-98e9-4547-b83f-a216139c59c2 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445871-522bf1ce-98e9-4547-b83f-a216139c59c2 "cd '/Volumes/My Shared Files/workspace' && ls -la && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445871-522bf1ce-98e9-4547-b83f-a216139c59c2
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-cpp"
    label: ":darwin: aarch64 - build-cpp"
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_CPP_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445877-51bb9a1f-da7a-4316-b5b9-56234d8cea54
    - tart run bun-build-1748826445877-51bb9a1f-da7a-4316-b5b9-56234d8cea54 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445877-51bb9a1f-da7a-4316-b5b9-56234d8cea54 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445877-51bb9a1f-da7a-4316-b5b9-56234d8cea54 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445877-51bb9a1f-da7a-4316-b5b9-56234d8cea54
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-zig"
    label: ":darwin: aarch64 - build-zig"
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    timeout_in_minutes: 35
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445882-84ba167d-636c-4309-9da7-8c0d2a637dbe
    - tart run bun-build-1748826445882-84ba167d-636c-4309-9da7-8c0d2a637dbe --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445882-84ba167d-636c-4309-9da7-8c0d2a637dbe "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun-zig --toolchain darwin-aarch64"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445882-84ba167d-636c-4309-9da7-8c0d2a637dbe
    depends_on:
    - build-base-image
  
- 
    key: "darwin-aarch64-build-bun"
    label: ":darwin: aarch64 - build-bun"
    depends_on:
    - darwin-aarch64-build-cpp
    - darwin-aarch64-build-zig
    - build-base-image
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_LINK_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445886-dcedfdfd-704b-4667-ba05-ff126f830611
    - tart run bun-build-1748826445886-dcedfdfd-704b-4667-ba05-ff126f830611 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445886-dcedfdfd-704b-4667-ba05-ff126f830611 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445886-dcedfdfd-704b-4667-ba05-ff126f830611
  
- 
    key: "darwin-x64-build-vendor"
    label: ":darwin: x64 - build-vendor"
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445891-e05ab817-0583-456d-b1bc-af6b5427b070
    - tart run bun-build-1748826445891-e05ab817-0583-456d-b1bc-af6b5427b070 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445891-e05ab817-0583-456d-b1bc-af6b5427b070 "cd '/Volumes/My Shared Files/workspace' && ls -la && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445891-e05ab817-0583-456d-b1bc-af6b5427b070
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-cpp"
    label: ":darwin: x64 - build-cpp"
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_CPP_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445895-fbe7cf42-4ac4-4e5c-a9c4-fb95eca9fb9b
    - tart run bun-build-1748826445895-fbe7cf42-4ac4-4e5c-a9c4-fb95eca9fb9b --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445895-fbe7cf42-4ac4-4e5c-a9c4-fb95eca9fb9b "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445895-fbe7cf42-4ac4-4e5c-a9c4-fb95eca9fb9b "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target dependencies"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445895-fbe7cf42-4ac4-4e5c-a9c4-fb95eca9fb9b
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-zig"
    label: ":darwin: x64 - build-zig"
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    timeout_in_minutes: 35
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445899-feab8806-5715-4e30-8c4c-5dc51c7e4ee6
    - tart run bun-build-1748826445899-feab8806-5715-4e30-8c4c-5dc51c7e4ee6 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445899-feab8806-5715-4e30-8c4c-5dc51c7e4ee6 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun-zig --toolchain darwin-x64"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445899-feab8806-5715-4e30-8c4c-5dc51c7e4ee6
    depends_on:
    - build-base-image
  
- 
    key: "darwin-x64-build-bun"
    label: ":darwin: x64 - build-bun"
    depends_on:
    - darwin-x64-build-cpp
    - darwin-x64-build-zig
    - build-base-image
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    env:
      BUN_LINK_ONLY: ON
      ENABLE_BASELINE: OFF
      ENABLE_CANARY: ON
      CANARY_REVISION: 1
      CMAKE_VERBOSE_MAKEFILE: ON
      CMAKE_TLS_VERIFY: 0
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445903-b53793b0-3496-4cc0-8495-77bc61c75446
    - tart run bun-build-1748826445903-b53793b0-3496-4cc0-8495-77bc61c75446 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445903-b53793b0-3496-4cc0-8495-77bc61c75446 "cd '/Volumes/My Shared Files/workspace' && bun run build:release --target bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445903-b53793b0-3496-4cc0-8495-77bc61c75446
  
- 
    key: "darwin-aarch64-14-test-bun"
    label: ":darwin: 14 aarch64 - test-bun"
    depends_on:
    - darwin-aarch64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445908-cadae9cd-7ddf-4591-96a0-d6084798e165
    - tart run bun-build-1748826445908-cadae9cd-7ddf-4591-96a0-d6084798e165 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445908-cadae9cd-7ddf-4591-96a0-d6084798e165 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-aarch64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445908-cadae9cd-7ddf-4591-96a0-d6084798e165
  
- 
    key: "darwin-aarch64-13-test-bun"
    label: ":darwin: 13 aarch64 - test-bun"
    depends_on:
    - darwin-aarch64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: arm64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445912-5e1c7d88-0ddd-46d6-9ed0-52609ac8362c
    - tart run bun-build-1748826445912-5e1c7d88-0ddd-46d6-9ed0-52609ac8362c --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445912-5e1c7d88-0ddd-46d6-9ed0-52609ac8362c "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-aarch64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445912-5e1c7d88-0ddd-46d6-9ed0-52609ac8362c
  
- 
    key: "darwin-x64-14-test-bun"
    label: ":darwin: 14 x64 - test-bun"
    depends_on:
    - darwin-x64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445916-dec814da-6569-4ea6-abce-9eba22f3fa06
    - tart run bun-build-1748826445916-dec814da-6569-4ea6-abce-9eba22f3fa06 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445916-dec814da-6569-4ea6-abce-9eba22f3fa06 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-x64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445916-dec814da-6569-4ea6-abce-9eba22f3fa06
  
- 
    key: "darwin-x64-13-test-bun"
    label: ":darwin: 13 x64 - test-bun"
    depends_on:
    - darwin-x64-build-bun
    - build-base-image
    agents:
      os: darwin
      arch: x64
      tart: true
    retry:
      manual:
        permit_on_passed: true
      automatic:
      - 
              exit_status: 1
              limit: 0
        
      - 
              exit_status: -1
              limit: 1
        
      - 
              exit_status: 255
              limit: 1
        
      - 
              signal_reason: cancel
              limit: 1
        
      - 
              signal_reason: agent_stop
              limit: 1
        
    cancel_on_build_failing: false
    parallelism: 2
    timeout_in_minutes: 30
    command:
    - tart list | awk '/stopped/ && $1 == "local" && $2 ~ /^bun-build-[0-9]+-[0-9a-f-]+$/ {print $2}' | xargs -n1 tart delete || true
    - log stream --predicate 'process == "tart" OR process CONTAINS "Virtualization"' > tart.log 2>&1 &
    - TART_LOG_PID=$!
    - trap 'if [ -n "$TART_LOG_PID" ]; then kill $TART_LOG_PID 2>/dev/null || true; fi; buildkite-agent artifact upload tart.log || true' EXIT
    - tart clone bun-build-macos-1.2.14 bun-build-1748826445920-a66c27ee-4b98-4ae9-90ff-c6ad407f7d42
    - tart run bun-build-1748826445920-a66c27ee-4b98-4ae9-90ff-c6ad407f7d42 --no-graphics --dir=workspace:$PWD > vm.log 2>&1 &
    - sleep 30
    - chmod +x .buildkite/scripts/run-vm-command.sh
    - .buildkite/scripts/run-vm-command.sh bun-build-1748826445920-a66c27ee-4b98-4ae9-90ff-c6ad407f7d42 "cd '/Volumes/My Shared Files/workspace' && ./scripts/runner.node.mjs --step=darwin-x64-build-bun"
    - buildkite-agent artifact upload vm.log || echo "No VM log to upload"
    - tart delete bun-build-1748826445920-a66c27ee-4b98-4ae9-90ff-c6ad407f7d42
  
- 
    key: release
    label: ":rocket:"
    agents:
      os: darwin
      arch: arm64
      tart: true
    depends_on:
    - darwin-aarch64-build-bun
    - darwin-x64-build-bun
    env:
      CANARY: 1
    command: ".buildkite/scripts/upload-release.sh"
  
- 
    key: benchmark
    label: 📊
    agents:
      os: darwin
      arch: arm64
      tart: true
    depends_on: "darwin-aarch64-build-bun"
    command: "node .buildkite/scripts/upload-benchmark.mjs"
  
